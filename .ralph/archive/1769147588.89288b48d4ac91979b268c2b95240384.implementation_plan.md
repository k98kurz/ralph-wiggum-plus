# Implementation Plan

## Tasks

### create_research_directory_structure

- Status: Pending
- Description: Create the `.research/{name}/` directory structure with all required subdirectories and files
- Acceptance Criteria:
  - Directory created at `.research/{name}/`
  - Subdirectories: `archive/`, `progress/`
  - `.research/templates/` directory created (for global template system)
  - `research.lock.json` initialized
  - `state.json` placeholder created
  - `progress.md` and `progress/` subdirectory initialized
  - `review.accepted.md` and `review.rejected.md` template files created
  - `complete.md` marker file placeholder created
  - `reports/{name}/` directory created

### adapt_locking_mechanism

- Status: Pending
- Description: Adapt ralph.py's locking mechanism for research.py with research.lock.json
- Acceptance Criteria:
  - `research.lock.json` created in `.research/{name}/`
  - Lock token generation and validation works
  - Stale lock detection (60 minute timeout)
  - `--force-resume` bypasses staleness check
  - Lock released on completion or signal

### implement_rwr_state

- Status: Pending
- Description: Implement RWRState dataclass for research state management
- Acceptance Criteria:
  - RWRState dataclass with fields: original_topic, breadth, depth, iteration, current_phase, failed_phase, retry_count, max_iterations, model, review_model, lock_token, start_time, phase_history, last_error, is_complete, mock_mode, phase_recovered, timeout
  - Serialization to state.json
  - Deserialization from state.json for resume
  - Crash recovery support
  - Periodic lock token refresh mechanism during active sessions

### implement_iteration_limit_calculation

- Status: Pending
- Description: Implement minimum iteration limit calculation (X^(Y+1)+5) with user confirmation and enforcement
- Acceptance Criteria:
  - Calculation function implemented (X^(Y+1)+5)
  - Warning displayed if max_iterations > 20
  - User confirmation required for high iteration counts
  - Minimum enforced if --max-iterations provided is too low
  - Formula documented in code
  - Iteration limit check integrated into main loop
  - Warning banner generation when limit reached during completion

### implement_initial_planning_phase

- Status: Pending
- Description: Implement initial planning phase that generates research_plan.md from original topic
- Acceptance Criteria:
  - Analyzes original topic to identify root research question(s)
  - Creates depth 0 topics for each major question (up to breadth X)
  - Writes initial research_plan.md in the specified format
  - Sets up acceptance criteria for each topic
  - Calculates and enforces minimum max_iterations
  - Warns user if iterations > 20 and confirms before proceeding

### create_research_plan_management

- Status: Pending
- Description: Implement research_plan.md creation, parsing, and updates
- Acceptance Criteria:
  - Initial plan generation from original topic
  - Parsing of topic hierarchy (depth 0, depth 1, etc.)
  - Status tracking (Pending, In Progress, In Review, Complete)
  - Acceptance criteria per topic/subtopic
  - Topic count statistics

### implement_progress_file_management

- Status: Pending
- Description: Implement overall progress.md and per-topic progress files
- Acceptance Criteria:
  - Overall progress.md with iteration summary and recent activity
  - Per-topic files in `progress/[topic_slug].md`
  - Topic slug generation (lowercase, hyphen-separated)
  - Findings, sources, and knowledge gaps sections
  - Subtopic direction notes

### implement_bfs_research_phase

- Status: Pending
- Description: Implement RESEARCH phase with breadth-first search traversal
- Acceptance Criteria:
  - Depth 0 topics researched first
  - Subtopics created up to configured depth
  - Breadth limit enforced (X subtopics per topic)
  - Progress files written for each topic
  - Research plan updated with new subtopics
  - Topics marked "In Review" after research

### implement_review_phase

- Status: Pending
- Description: Implement REVIEW phase for research topic acceptance
- Acceptance Criteria:
  - Review in-progress topics from research_plan.md
  - Knowledge gap analysis performed
  - review.accepted.md created for approved topics
  - review.rejected.md created for topics needing more research
  - Topic status updated (Complete or back to In Progress)

### implement_synthesize_phase

- Status: Pending
- Description: Implement SYNTHESIZE phase for final report generation
- Acceptance Criteria:
  - All progress files compiled into unified report
  - Executive summary generated
  - Findings organized by topic hierarchy
  - Sources/references section with citations
  - Report written to `reports/{name}/report.md`

### implement_final_review_revise_cycle

- Status: Pending
- Description: Implement final REVIEW â†’ REVISE cycle for report quality
- Acceptance Criteria:
  - Final quality review evaluates completeness, coherence, quality, professionalism
  - review.rejected.md triggers revise phase
  - review.accepted.md completes research
  - Multiple revision cycles supported

### implement_template_system

- Status: Pending
- Description: Implement research-specific template system with variable interpolation
- Acceptance Criteria:
  - Templates stored in `.research/templates/` (global, shared across sessions)
  - Default templates created on first run if not present
  - Available templates: initial_plan, research, review, synthesize, final_review, revise, recovery, phase_recovery
  - Variable interpolation ($original_topic, $breadth, $depth, etc.)
  - Template validation on startup

### implement_cli_parameters

- Status: Pending
- Description: Implement CLI parameter parsing for research.py
- Acceptance Criteria:
  - --breadth X (default 3)
  - --depth Y (default 3)
  - --name Z (required)
  - --max-iterations N (calculated minimum with validation)
  - Iteration limit calculation validation and user confirmation for high counts (> 20)
  - Minimum iteration enforcement logic
  - --model MODEL (default: opencode/minimax-m2.1-free)
  - --review-model REVIEW_MODEL (default: opencode/big-pickle)
  - --timeout TIMEOUT (default 1200)
  - --resume / --force-resume
  - --mock-mode
  - --reorganize-archive

### implement_archive_management

- Status: Pending
- Description: Implement archival of intermediate files with subtopic support
- Acceptance Criteria:
  - Files archived to `.research/{name}/archive/`
  - Subdirectory traversal algorithm to identify all topic subdirectories in `progress/`
  - Progress files in subdirectories archived with subtopic prefix (e.g., `{subtopic}.progress.md`)
  - Timestamp and lock token in archive filenames
  - Hash-based deduplication
  - --reorganize-archive reorganizes archives by token

### implement_completion_detection

- Status: Pending
- Description: Implement completion detection and finalization
- Acceptance Criteria:
  - All topics marked Complete triggers completion
  - completed.md marker file created
  - Warning banner added if iteration limit reached
  - Intermediate files cleaned up
  - Lock released
  - Completion summary displayed

### implement_error_handling_recovery

- Status: Pending
- Description: Implement phase failure recovery and retry system
- Acceptance Criteria:
  - Phase failures detected and logged
  - Recovery phase executed with analysis
  - Maximum 3 retry attempts per phase
  - Recovery notes written to file
  - Crash recovery via state.json
  - Signal handlers for graceful shutdown

### integrate_main_loop

- Status: Pending
- Description: Integrate all components into main research loop
- Acceptance Criteria:
  - Initial planning phase creates research_plan.md
  - RESEARCH-REVIEW cycle until all complete or max_iterations
  - SYNTHESIZE-REVIEW-REVISE final cycle
  - State persisted after each iteration
  - Iteration limit enforced
  - Signal handlers configured for graceful shutdown
  - Crash recovery support via state.json

## Dependencies

1. **create_research_directory_structure** must be completed before any other task
2. **adapt_locking_mechanism** depends on directory structure
3. **implement_rwr_state** depends on directory structure
4. **implement_iteration_limit_calculation** is independent
5. **implement_initial_planning_phase** depends on iteration limit calculation and RWRState
6. **create_research_plan_management** depends on initial planning phase
7. **implement_progress_file_management** depends on research plan management
8. **implement_bfs_research_phase** depends on progress file management and template system
9. **implement_review_phase** depends on BFS research phase
10. **implement_synthesize_phase** depends on progress file management
11. **implement_final_review_revise_cycle** depends on synthesize phase
12. **implement_template_system** is independent
13. **implement_cli_parameters** depends on state management
14. **implement_archive_management** depends on directory structure and template system
15. **implement_completion_detection** depends on all phase implementations
16. **implement_error_handling_recovery** depends on phase implementations
17. **integrate_main_loop** depends on all other tasks
