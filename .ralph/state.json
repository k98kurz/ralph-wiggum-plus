{
  "iteration": 15,
  "current_phase": "REVIEW",
  "failed_phase": null,
  "retry_count": 0,
  "max_iterations": 20,
  "enhanced_mode": true,
  "test_instructions": "You should test your work with mock mode and follow the conventions from test_ralph.py in test_research.py",
  "review_every": 0,
  "model": "opencode/minimax-m2.1-free",
  "review_model": "opencode/big-pickle",
  "lock_token": "faa5ac79f9100a33a3a243a5027e312c",
  "start_time": 1769158544.428327,
  "phase_history": [
    "BUILD_1",
    "REVIEW_1",
    "COMMIT_1",
    "BUILD_2",
    "REVIEW_2",
    "COMMIT_2",
    "BUILD_3",
    "REVIEW_3",
    "COMMIT_3",
    "BUILD_4",
    "REVIEW_4",
    "COMMIT_4",
    "BUILD_5",
    "REVIEW_5",
    "COMMIT_5",
    "BUILD_6",
    "REVIEW_6",
    "COMMIT_6",
    "BUILD_7",
    "REVIEW_7",
    "COMMIT_7",
    "BUILD_8",
    "REVIEW_8",
    "COMMIT_8",
    "BUILD_9",
    "REVIEW_9",
    "COMMIT_9",
    "BUILD_10",
    "REVIEW_10",
    "COMMIT_10",
    "BUILD_11",
    "REVIEW_11",
    "COMMIT_11",
    "BUILD_12",
    "REVIEW_12",
    "COMMIT_12",
    "BUILD_13",
    "REVIEW_13",
    "COMMIT_13",
    "BUILD_14",
    "REVIEW_14",
    "COMMIT_14",
    "BUILD_15",
    "REVIEW_15"
  ],
  "last_error": null,
  "final_review_requested": true,
  "is_complete": false,
  "mock_mode": false,
  "push_commits": false,
  "original_prompt": "The goal is to create a research tool based upon the structure of ralph.py,\ncalled research.py. The general concept is to replace coding tasks with research\ntasks, replacing the BUILD-PLAN and BUILD-REVIEW-PLAN/COMMIT cycles with a\nRESEARCH-REVIEW-SYNTHESIZE cycle. The tool will instruct the AI agent in the\nRESEARCH phase to do background research on the original topic/question, performing\na breadth-first search traversal with configurable breadth and depth parameters.\nAt the end, a report will be synthesized through an automatic final cycle.\n\n# Filename Changes\n\n- `implementation_plan.md` -> `research_plan.md`\n- `.ralph/*` -> `.research/{name}/*`\n- `ralph.lock.json` -> `research.lock.json`\n- `progress.md` preserved (with per-topic `progress/[topic_slug].md` subdirectory)\n- All process files will be written in a new `.research/{name}` folder rather than in\nthe current working directory (see `--name` CLI parameter)\n- Final reports:\n    - `reports/{name}/` directory for reports on researched topics\n    - `report.md` (research mode)\n\n# CLI Parameters\n\n## Customization Parameters\n- `--breadth X`: defaults to 3\n- `--depth Y`: defaults to 3\n- `--name Z`: name for the research session (used in directory structure `.research/{name}/` and `reports/{name}/`)\n- `--max-iterations N`: maximum number of RESEARCH-REVIEW cycles (default: calculated as X^(Y+1)+5 where X=breadth, Y=depth; minimum value is enforced)\n- `--reorganize-archive`: reorganize archives in `.research/{name}/archive/` -> `.research/{name}/archive/{token}/`\n\n## Model & Execution Parameters (from ralph.py)\n- `--model MODEL`: AI model to use for research (default: opencode/minimax-m2.1-free)\n- `--review-model REVIEW_MODEL`: AI model to use for reviews (default: opencode/big-pickle)\n- `--timeout TIMEOUT`: Timeout in seconds for OpenCode calls (default: 1200)\n- `--resume`: Resume from a previous session using saved state in `.research/{name}/state.json`\n- `--force-resume`: Force resume by removing any existing lock file (bypasses staleness check)\n- `--mock-mode`: Use mock mode for testing (no external AI calls)\n\n## Removed Parameters (not applicable to research)\n- `--review-every`: every topic is reviewed anyway\n- `--enhanced`: always uses full RESEARCH-REVIEW cycle\n- `--final-review`: automatic when complete\n- `--push-commits`: not applicable to research\n\n# File Organization\n\n## Directory Structure\n```\n.research/{name}/\n\u251c\u2500\u2500 research.lock.json           # Session lock file\n\u251c\u2500\u2500 state.json                   # Persistent state for crash recovery\n\u251c\u2500\u2500 research_plan.md             # Research topics tree with status tracking\n\u251c\u2500\u2500 progress.md                  # Overall research progress notes\n\u251c\u2500\u2500 progress/[topic_slug].md     # Per-topic/subtopic detailed notes\n\u251c\u2500\u2500 review.accepted.md  # Approval markers\n\u251c\u2500\u2500 review.rejected.md  # Critique with gaps to address\n\u251c\u2500\u2500 complete.md         # Marker file when research is complete\n\u2514\u2500\u2500 archive/                     # Archived intermediate files\n\nreports/{name}/\n\u2514\u2500\u2500 report.md                 # Synthesized final report\n```\n\n## State Persistence\n- `state.json` contains serialized RWRState:\n```python\n@dataclass\nclass RWRState:\n    \"\"\"Represents the current state of the RWR process.\"\"\"\n    original_topic: str = field(default=\"\")\n    breadth: int = field(default=3)\n    depth: int = field(default=3)\n    iteration: int = field(default=0)\n    current_phase: str = field(default=Phase.RESEARCH.value)\n    failed_phase: str | None = field(default=None)\n    retry_count: int = field(default=0)\n    max_iterations: int = field(default=DEFAULT_MAX_ITERATIONS)\n    model: str = field(default=DEFAULT_MODEL)\n    review_model: str = field(default=DEFAULT_REVIEW_MODEL)\n    lock_token: str | None = field(default=None)\n    start_time: float = field(default=0.0)\n    phase_history: list[str] = field(default_factory=list)\n    last_error: str | None = field(default=None)\n    is_complete: bool = field(default=False)\n    mock_mode: bool = field(default=False)\n    phase_recovered: bool = field(default=False)\n    timeout: int = field(default=OPENCODE_TIMEOUT)\n```\n- Enables crash recovery and session resumption\n- Similar to ralph.py's state management\n\n# File Format Specifications\n\n## research_plan.md Format\n```markdown\n# Research Plan\n\n## Metadata\n- Topic: [original research topic or question]\n- Breadth: X\n- Depth: Y\n\n## Topics\n\n### [Topic Name] (Depth: 0)\n- Status: Pending | In Progress | In Review | Complete\n- Description: Brief description of the topic\n- Acceptance Criteria:\n  - Criterion 1\n  - Criterion 2\n  - Criterion 3\n\n### [Subtopic Name] (Depth: 1)\n- Status: Pending | In Progress | In Review | Complete\n- Parent: [Parent Topic Name]\n- Description: Brief description of the subtopic\n- Acceptance Criteria:\n  - Criterion 1\n  - Criterion 2\n\n## Completion Status\n- Total Topics: N\n- Complete: M\n- In Progress: P\n- Pending: Q\n```\n\n## progress.md Format (Overall)\n```markdown\n# Research Progress\n\n## Summary\n- Iteration: N\n- Topics Completed: M of P\n\n## Recent Activity\n- [Most recent findings or reviews]\n```\n\n## progress/[topic_slug].md Format (Per-Topic)\n```markdown\n# Progress: [Topic Name]\n\n## Findings\n- Key finding 1 with sources\n- Key finding 2 with sources\n\n## Sources\n- Source 1: [URL or citation]\n- Source 2: [URL or citation]\n\n## Knowledge Gaps\n- Gap 1: [description]\n- Gap 2: [description]\n\n## Notes for Subtopics (if applicable)\n- Subtopic 1: [directions for research]\n- Subtopic 2: [directions for research]\n```\n\n# Phases/Process\n\n## Overview\n\nThe tool operates in one primary mode:\n- **Research Mode**: Initial research from scratch using RESEARCH-REVIEW cycles\n\nBoth modes conclude with an automatic final cycle: SYNTHESIZE-REVIEW-REVISE\n\n## Iteration Limit Enforcement\n\nThe tool calculates a minimum safe iteration limit: `X^(Y+1) + 5`, where X=breadth and Y=depth.\n- If `--max-iterations` is not provided, this calculated minimum is used\n- If `--max-iterations` is provided but less than the minimum, the minimum is enforced\n- If the iteration limit is reached before all topics are complete:\n  - A warning is prepended to the final report file\n  - The final SYNTHESIZE-REVIEW-REVISE cycle still executes\n  - The warning indicates that research may be incomplete\n\n---\n\n## Research Mode\n\n### Initial Planning (One-time Setup)\n\nGenerate the initial `research_plan.md` by:\n1. Calculate and enforce minimum `max_iterations` as `X^(Y+1) + 5`\n    - Warn the user if the calculated `max_iterations` is greater than 20\n    - User must then confirm before the loop begins\n2. Analyzing the topic to identify root research question(s)\n3. Creating depth 0 topics for each major question (up to breadth X)\n4. Setting up `.research/{name}/` and `reports/{name}/` directory structures\n5. Writing `research_plan.md` in the specified format\n\n### Main Loop: RESEARCH-REVIEW Cycle\n\nThe tool cycles through RESEARCH \u2192 REVIEW until all topics are marked \"Complete\" or max_iterations is reached.\n\n#### RESEARCH Phase\n\nExecute in this order:\n\n1. **Check for high-level topics** (depth 0) marked \"Pending\" or \"In Progress\" (AI agent)\n   - If found:\n     - Compile notes from X searches on the topic using web and file search tools\n     - Identify up to X subtopics to explore (depth + 1)\n     - Write/update `progress/[topic_slug].md` with detailed findings\n     - Update overall `progress.md` with summary\n     - Update `research_plan.md` with any new subtopics (if depth < Y)\n     - Mark topic status to \"In Review\" in `research_plan.md`\n     - Increment iteration counter\n     - Halt\n\n2. **Check for lower-level topics** (depth > 0) marked \"Pending\" or \"In Progress\" (AI agent)\n   - Prioritize tasks with lower depth\n   - If found:\n     - Compile notes from X searches on the topic using web and file search tools\n     - If depth < Y: identify up to X additional subtopics (depth + 1) to explore\n     - Write/update `progress/[topic_slug].md` with detailed findings\n     - Update overall `progress.md` with summary\n     - Update `research_plan.md` with any new subtopics (if depth < Y)\n     - Mark subtopic status to \"In Review\" in `research_plan.md`\n     - Increment iteration counter\n     - Halt\n\n3. **If all tasks are marked \"Complete\"** (AI agent)\n    - Create `.research/{name}/completed.md` file with just the content <promise>COMPLETE</promise>\n    - Halt\n\n4. **Check for completion or iteration limit** (script)\nFrom the current ralph.py script:\n```python\ndef main_loop(state: RWRState):\n    ...\n    while state.iteration < state.max_iterations and not state.is_complete:\n        state.iteration += 1\n        ...\n        # Check for completion promise\n        state.is_complete = check_for_completion(state)\n        ...\n```\n\n#### REVIEW Phase\n\nExecute when `research_plan.md` contains items marked \"In Review\":\n\n1. Look at `research_plan.md` for any item marked \"In Review\"\n2. Review the corresponding `progress/[topic_slug].md` file for that topic/subtopic\n3. Perform knowledge gap analysis identifying weak areas\n4. Create exactly one of:\n   - `review.rejected.md`: specific knowledge gaps and action items required, then update topic/subtopic status back to \"In Progress\" in `research_plan.md`\n   - `review.accepted.md`: confirmation that findings are acceptable, then mark the topic/subtopic as \"Complete\" in `research_plan.md`\n5. Halt\n\n---\n\n## Final Cycle: SYNTHESIZE-REVIEW-REVISE (Automatic)\n\nThis cycle runs automatically when:\n- `completed.md` file is created, OR\n- max_iterations has been reached\n\n### SYNTHESIZE Phase\n\n1. Compile all `progress/[topic_slug].md` files into a unified report\n2. Create the appropriate output file: `reports/{name}/report.md`\n3. Format requirements:\n   - Executive summary of key findings\n   - Findings organized by topic hierarchy (mirroring `research_plan.md` structure)\n   - Sources/references section with proper citations\n   - Clear, professional writing suitable for the target audience\n4. Halt\n\n### REVIEW Phase (Final)\n\n1. Read the synthesized report `report.md`\n2. Evaluate for:\n   - Completeness: Does it address all topics from the research plan?\n   - Coherence: Is the writing logical and well-structured?\n   - Quality: Are findings supported by evidence and properly cited?\n   - Professionalism: Is the tone appropriate and free of errors?\n3. Create exactly one of:\n   - `review.rejected.md`: specific quality issues requiring revision, proceed to REVISE phase\n   - `review.accepted.md`: confirmation the report is satisfactory, mark research complete\n4. Halt\n\n### REVISE Phase (Conditional)\n\nOnly runs if the final REVIEW phase creates `review.rejected.md`:\n\n1. Read the critique in `review.rejected.md`\n2. Make targeted revisions to the report addressing the identified issues\n3. Do NOT add new research or go back to RESEARCH phase\n4. Create `review.accepted.md` when revisions are complete\n5. Halt\n\n### Automatic Archiving of Intermediate Files\n\nSimilarly to ralph.py, research.py will archive intermediate files. However, since the\nBFS system includes subtopics and places progress files for each subtopic in its own\nsubdirectory, it will have to be adapted as follows:\n\n1. Add a check that goes through the subdirectories of `.research/{name}/progress/`\nto identify subtopics. (Add to `archive_any_process_files`.)\n2. Attempt to archive the `progress.md` files in those subdirectories by prepending\nthe subtopic name to the filename, e.g. `{subtopic}.progress.md`, then prepend the\ntimestamp and token as normal. (Add optional `prepend: str` argument to\n`archive_intermediate_file`.)\n\n### Completion\n\nWhen the final REVIEW phase creates `review.accepted.md`:\n\n1. If iteration limit reached: script will prepend warning banner at top of report:\n```markdown\n---\n\u26a0\ufe0f **WARNING: ITERATION LIMIT REACHED**\n\nThis report was generated before all research topics were completed due to reaching the maximum iteration limit. Some findings may be incomplete or missing.\n\n- Topics completed: M of N\n- Iterations executed: K (limit: max_iterations)\n- To complete this research, resume with higher --max-iterations or run again without the limit\n---\n```\n2. Archive intermediate files to `.research/{name}/archive/`\n3. Clean up intermediate files in `.research/{name}/`, including\n`.research/{name}/progress/*`\n4. Release lock file\n5. Display completion summary (including warning if iteration limit was reached)\n\n# Completion Conditions\n\nThe research tool will complete successfully when:\n\n1. Either:\n   - All topics in `research_plan.md` are marked \"Complete\" (i.e. the AI agent\n    creates the `completed.md` file), OR\n   - max_iterations has been reached (with warning in report)\n2. The final SYNTHESIZE-REVIEW-REVISE cycle has been executed\n\nThe RESEARCH-REVIEW loop will signal completion by creating\n`<promise>COMPLETE</promise>` in `.research/{name}/completed.md`, analogous to\nralph.py's completion mechanism.\n\nIf max_iterations was reached, the report will contain a warning banner indicating\nincomplete research.\n\n# Template System\n\nThe prompt template system used in ralph.py is preserved. Only the template names,\nprompt generator functions, and default templates are changed.\n\nThe tool uses customizable prompt templates stored in `.research/templates/`.\nOn first run, templates are created with sensible defaults.\n\nTemplates use `$variable` syntax (e.g., `$original_topic`, `$breadth`, `$depth`,\n`$iteration`, `$max_iterations`, `$model`, `$review_model`, `$timeout`) for state interpolation.\nAll templates are validated on startup; invalid variables or syntax errors are\nreported before the main loop begins.\n\nAvailable templates:\n- `initial_plan.md` - Initial research plan generation\n- `research.md` - Research phase prompt\n- `review.md` - Review phase prompt\n- `synthesize.md` - Synthesis phase prompt (final report generation)\n- `final_review.md` - Final quality review prompt\n- `revise.md` - Report revision prompt\n- `recovery.md` - Recovery from phase failures\n- `phase_recovery.md` - Appended to templates when retrying after recovery\n\nThis aligns with ralph.py's template system, allowing for similar customization capabilities.\n\n# Error Handling & Recovery\n\nThe tool preserves ralph.py's phase recovery and retry system:\n\n## Phase Failure Recovery\n- If any phase fails (timeout, error, etc.), the tool enters RECOVERY phase\n- Maximum retry attempts: 3 per phase\n- Recovery notes written to `.research/{name}/recovery.notes.md`\n- After recovery, the failed phase is retried with updated context\n- Timeout is configurable via `--timeout` parameter\n\n## Locking Mechanism\n- `research.lock.json` prevents concurrent research sessions for the same topic\n- Lock includes timestamp, lock token, and process ID\n- Stale locks (> 60 minutes) are automatically removed\n- Lock is updated periodically during active sessions\n- `--force-resume` bypasses staleness check and removes lock\n\n## Crash Recovery\n- State persisted to `state.json` after each phase\n- Sessions can be resumed using `--resume` flag\n- `--force-resume` removes stale lock and allows resumption\n- Full phase history tracked in state for debugging\n\n## Testing Mode\n- `--mock-mode` enables testing without external AI calls\n- Useful for development and debugging\n- Returns mock responses instead of calling OpenCode\n\n## Iteration Limit Handling\n- If max_iterations is reached, research stops but synthesis still occurs\n- Warning banner prepended to final report\n- User can resume with higher iteration limit if needed\n\n# Additional Notes\n\n## Iteration Limit Calculation\n\nThe minimum safe iteration limit is calculated as: `X^(Y+1) + 5`\n\n**Rationale**:\n- A complete breadth-first search with depth Y and breadth X requires approximately X^(Y+1) topics\n- Each topic requires at least one RESEARCH-REVIEW cycle (one iteration)\n- The +5 buffer accounts for edge cases, rejected work requiring re-research, and the final SYNTHESIZE-REVIEW-REVISE cycle\n\n**Examples**:\n- Breadth=3, Depth=3: minimum = 3^(3+1) + 5 = 81 + 5 = 86 iterations\n- Breadth=2, Depth=2: minimum = 2^(2+1) + 5 = 8 + 5 = 13 iterations\n- Breadth=4, Depth=2: minimum = 4^(2+1) + 5 = 64 + 5 = 69 iterations\n\n## Breadth and Depth Enforcement\n- If fewer than X subtopics can be found for a topic, the agent should not force additional subtopics\n- When depth Y is reached, no new subtopics should be created (leaf nodes only)\n- The agent should focus on deeper research of existing topics rather than creating spurious subtopics\n\n## Topic Selection Priority\nThe RESEARCH phase follows this priority order:\n1. High-level topics (depth 0) marked \"Pending\" or \"In Progress\"\n2. Lower-level topics (depth > 0) marked \"Pending\" or \"In Progress\"\n3. Check iteration limit: if reached, proceed to synthesis\n4. If no topics found and iteration limit not reached, proceed to synthesis\n\n## File Naming Conventions\n- Topic slugs for progress files: lowercase, hyphen-separated, no special characters\n- Example: \"Machine Learning Fundamentals\" \u2192 `progress/machine-learning-fundamentals.md`\n\n## Concurrent Research\nThe `.research/{name}/` structure allows multiple concurrent research sessions on different topics, but prevents concurrent modification of the same research session via the lock file.\n\n## Model Configuration\n- `--model`: Configures the AI model used for research phases (default: opencode/minimax-m2.1-free)\n- `--review-model`: Configures the AI model used for review phases (default: opencode/big-pickle)\n- Use higher-quality models for reviews for better quality control\n\n# Implementation Notes for Developers\n\n## Key Differences from ralph.py\n\n| Aspect              | ralph.py                               | research.py                                         |\n|---------------------|----------------------------------------|-----------------------------------------------------|\n| Primary cycle       | BUILD-PLAN or BUILD-REVIEW-PLAN-COMMIT | RESEARCH-REVIEW + SYNTHESIZE-REVIEW-REVISE          |\n| Task types          | Coding tasks                           | Research topics/subtopics                           |\n| Output files        | Code changes, commits                  | Research reports                                    |\n| Traversal strategy  | Priority-based                         | Breadth-first search with depth limit               |\n| Directory structure | `.ralph/`                              | `.research/{name}/` + `reports/{name}/`             |\n| Lock file           | `ralph.lock.json`                      | `research.lock.json`                                |\n| Progress file       | progress.md                            | progress.md + progress/[topic_slug].md              |\n| Plan file           | implementation_plan.md                 | research_plan.md                                    |\n| Iteration limit     | Configurable, default 20               | Calculated minimum X^(Y+1)+5, configurable          |\n| Final cycle         | Optional (requires `--final-review`)   | Automatic when all topics complete or limit reached |\n| Parallelism         | Sequential                             | Sequential (avoid race conditions)                  |\n\n## Preserved Features from ralph.py\n- State management (`state.json`)\n- Locking mechanism\n- Phase recovery and retry system\n- Template system with variable interpolation\n- Archival of intermediate files\n- `--reorganize-archive` functionality\n- `--model` and `--review-model` parameters\n- `--timeout` parameter\n- `--resume` and `--force-resume` parameters\n- `--mock-mode` parameter\n\n## Simplified Feature Set (removed from ralph.py)\n- `--review-every` (every topic is reviewed anyway)\n- `--enhanced` mode (always uses RESEARCH-REVIEW cycle)\n- `--final-review` flag (automatic SYNTHESIZE-REVIEW-REVISE when complete)\n- `--push-commits` (not applicable to research)\n\n## Implementation Priority\n1. File structure and locking mechanism (.research/{name}/research.lock.json, .research/{name}/)\n2. State management adapted for research tasks (including iteration tracking)\n3. Minimum max_iteration calculation and enforcement (X^(Y+1)+5)\n4. Template system initialization\n5. RESEARCH-REVIEW cycle implementation\n6. SYNTHESIZE-REVIEW-REVISE final cycle\n7. Completion detection and reporting\n8. Warning banner generation when iteration limit reached\n9. CLI parameter handling (model, review_model, timeout, resume, force-resume, mock-mode, max-iterations, name)",
  "phase_recovered": false,
  "timeout": 1200
}